---
- name:  "register domain name"
  set_fact:
    domain_name: "{{ item }}"

- name: "register logging_server for domain {{ domain_name }}"
  set_fact:
     logging_server: "{{ hostvars['access.seinternal.com']['logging_filters'][domain_name] }}"

- name: register archive_options for domain {{ domain_name }}"
  set_fact:
     active: "{{ hostvars['access.seinternal.com']['archive_options'][domain_name] }}"

- name: "Create remove_index script (purge the old archive index from the logging source_server)"
  template:
    src: templates/remove_index.py.j2
    dest: /tmp/remove_index.sh
    mode: "a+x"
- name: "Purge the old archive index from the logging source_server"
  command: python /tmp/remove_index.py
  when: logging_server == old_server and active == 1
