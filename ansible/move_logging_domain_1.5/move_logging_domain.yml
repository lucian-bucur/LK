---
# 1. determine source_server (where the domain is located)
- hosts: access.seinternal.com
  gather_facts: no
  tasks:
    - name: "Get master server"
      get_servers_with_role:
        host: "{{ old_server }}"
        role: master
      register: master
    - debug: var=master.meta[0]

    - name: "Check logging server name"
      command: mysql filter -N -e "select logging_server from relays where domain='{{ domain_name }}'"
      register: logging_server
      delegate_to: "{{ master.meta[0] }}"
    - debug: var=logging_server.stdout

    - name: Exit if logging_server is not the same as source_server
      fail: msg="logging_server {{ logging_server.stdout }} is not the same as source_server {{ old_server }}"
      when: logging_server.stdout != old_server

# 2. ssh authorization (source_server to destination_server)
- import_playbook: ssh_authorize.yml
  vars:
    source: "{{ new_server }}"
    destination: "{{ old_server }}"

# 3. check if archiving is enabled for the domain and if is the case purge old archive from the old logging server
- hosts: access.seinternal.com
  gather_facts: no
  tasks:
    - name: "Check if archiving is enabled for the domain"
      command: mysql filter -N -e "select active from archive.options where domain='{{ domain_name }}'"
      register: active
      delegate_to: "{{ master.meta[0] }}"
    - debug: var=active.stdout

    - name: "Create remove_index script"
      template:
        src: templates/remove_index.py.j2
        dest: /tmp/remove_index.sh
        mode: "a+x"
      delegate_to: "{{ master.meta[0] }}"
    - name: "purge the old archive index from the old logging server"
      command: python /tmp/remove_index.py
      when: active.stdout == 1
      delegate_to: "{{ master.meta[0] }}"

# 4. set source_server & target_server to maintenance
- hosts: access.seinternal.com
  gather_facts: no
  tasks:
    - name: "Add server to maintenance"
      local_action:
        module: zabbix_maintenance
        name: "Logging domain migration to {{ new_server }}"
        host_names:
          - "{{ old_server }}"
          - "{{ new_server }}"
        state: present
        collect_data: False
        server_url: https://monitor.seinternal.com
        login_user: "{{ zabbix_user }}"
        login_password: "{{ zabbix_password }}"

# 5. stop services on source_server
- hosts: "{{ old_server }}"
  become: true
  gather_facts: no
  tasks:
    - name: Stop services
      service:
        name: "{{ item }}"
        state: stopped
      loop:
        - logging_tasks
        - logging_scheduled
        - sphinxsearch
        - mysql
    - name: Flush MySQL Tables
      command: mysqladmin flush-tables

# 6. move logging storage for a domain between servers
- hosts: "{{ new_server }}"
  become: true
  gather_facts: no
  tasks:
    - name:  register cluster name
      set_fact:
        cluster: "{{ old_server.partition('.')[2] }}"
    - name:  register table name
      set_fact:
        table: "{{ domain_name | replace('.','_') }}"
    - name:  register domain_mask name
      set_fact:
        domain_mask: "{{table + '.{frm,MYD,MYI}'}}"
    - set_fact:
        report:
          cluster: "{{ cluster }}"
          table:   "{{ table }}"
          domain:  "{{ domain_name }}"
          domain_mask: "{{ domain_mask }}"
    - debug: var=report

    - name: "Copy migrate logging domain script"
      template:
        src: templates/migrate_logging_domain.j2
        dest: /root/migrate_logging_domain.sh
        mode: "a+x"
    - name: "execute migrate logging domain script"
      command: /root/migrate_logging_domain.sh

# 7. update filter table for target_server
- hosts: "{{ new_server }}"
  become: true
  gather_facts: no
  tasks:
    - name: mysql filter table update on relays
      command: mysql filter -e "update relays set logging_server='{{ new_server }}' where logging_server='{{ old_server }}'"

    - name: Repair transferred tables
      command: "mysqlcheck --auto-repair {{ item}}"
      loop:
        - mx_messages
        - mx_messages_outgoing

# 8. start services on source_server
- hosts: "{{ old_server }}"
  become: true
  gather_facts: no
  tasks:
    - name: Start services
      service:
        name: "{{ item }}"
        state: started
      loop:
        - mysql
        - sphinxsearch
        - logging_scheduled
        - logging_tasks

# 9. remove zabbix maintenance for source_server & target_server
- hosts: access.seinternal.com
  gather_facts: no
  tasks:
    - name: "Remove zabbix maintenance"
      local_action:
        module: zabbix_maintenance
        name: "Logging domain migration to {{ new_server }}"
        host_names:
          - "{{ old_server }}"
          - "{{ new_server }}"
        state: absent
        server_url: https://monitor.seinternal.com
        login_user: "{{ zabbix_user }}"
        login_password: "{{ zabbix_password }}"
