---
- name: "check if the server role is {{ item }}"
  lineinfile:
    dest: /etc/spamexperts/cluster.conf
    line: "is_{{ item }} = True"
  check_mode: yes
  register: presence
  failed_when: presence.failed

- name: export 1
  set_fact:
      append_dict: "{ 'server_hostname[{{ inventory_hostname }}] role={{ item }}' : 'True' }"
  when: not presence.changed
- name: export 2
  set_fact:
      append_dict: "{ 'server_hostname[{{ inventory_hostname }}] role={{ item }}' : 'False' }"
  when: presence.changed

# REPORTS
# ------------------------------------------------------------------------------
- name: export 3
  set_fact:
      dict: "{{ dict | combine(append_dict) }}"
  when: not presence.changed
